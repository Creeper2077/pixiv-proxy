user www;
worker_processes auto;
pid /run/nginx.pid;

events {
use epoll;
worker_connections 1024;
multi_accept on;
}

http {
    #Sendfile
    include /etc/nginx/mime.types;
	default_type application/octet-stream;
    sendfile on;
    tcp_nopush on;

    #Timeout
	keepalive_timeout 60;
    tcp_nodelay on;
    client_header_buffer_size 4k;
    open_file_cache max=102400 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 1;
    client_header_timeout 15;
    client_body_timeout 15;
    reset_timedout_connection on;
    send_timeout 15;
    server_tokens off;
    client_max_body_size 10m;

    #gzip
    gzip on;
    gzip_min_length 2k;
    gzip_buffers 4 32k;
    gzip_http_version 1.1;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/javascriptapplication/json application/javascript application/x-javascriptapplication/xml;
    gzip_vary on;
    gzip_proxied any;

    #pixiv.net
    server {
    	listen @PORT@;
        listen [::]:@PORT@;
	    server_name @PIXIV_DOMAIN2@;
        set $domain $1;
        resolver 8.8.8.8;
        if ($http_user_agent ~* "qihoobot|Baiduspider|Googlebot|Googlebot-Mobile|Googlebot-Image|Mediapartners-Google|Adsbot-Google|Feedfetcher-Google|Yahoo! Slurp|Yahoo! Slurp China|YoudaoBot|Sosospider|Sogou spider|Sogou web spider|MSNBot|ia_archiver|Tomato Bot|^$") {  
            return 403;
        }
        location ~ .*
        {
            proxy_set_header Host $domain.pixiv.net;
            proxy_set_header Referer "https://www.pixiv.net";
            proxy_cookie_domain pixiv.net @PIXIV_DOMAIN@;
            proxy_pass https://$domain.pixiv.net;
            proxy_ssl_server_name on;
            proxy_set_header Accept-Encoding "";
            proxy_redirect https://accounts.pixiv.net/ https://accounts.@PIXIV_DOMAIN@/;

            sub_filter "i-cf.pximg.net" "i.@PIXIV_DOMAIN@";
            sub_filter "pixiv.net" "@PIXIV_DOMAIN@";
            sub_filter "pximg.net" "@PXIMG_DOMAIN@";
            sub_filter "js_error.php" "block_js_error";
            sub_filter "www.google" "block_google";
            sub_filter_once off;
            sub_filter_types *;
        }
        location ~* \.(ico|jpe?g|gif|png|bmp|swf|flv)$ {
            expires 30d;
            log_not_found off;
            access_log off;
        }
        location ~* \.(js|css)$ {
            expires 7d;
            log_not_found off;
            access_log off;
        } 
    }

    #pximg.net
    server
    {
        listen @PORT@;
        listen [::]:@PORT@;
        server_name @PXIMG_DOMAIN2@;
        set $domain $1;
        resolver 8.8.8.8;
        if ($http_user_agent ~* "qihoobot|Baiduspider|Googlebot|Googlebot-Mobile|Googlebot-Image|Mediapartners-Google|Adsbot-Google|Feedfetcher-Google|Yahoo! Slurp|Yahoo! Slurp China|YoudaoBot|Sosospider|Sogou spider|Sogou web spider|MSNBot|ia_archiver|Tomato Bot|^$") {  
            return 403;
        }
        location ~ .*
        {
            proxy_set_header Host $domain.pximg.net;
            proxy_set_header Referer "https://www.pixiv.net";
            proxy_pass https://$domain.pximg.net;
            proxy_ssl_server_name on;
            proxy_set_header Accept-Encoding "";

            sub_filter "i-cf.pximg.net" "i.@PIXIV_DOMAIN@";
            sub_filter "pixiv.net" "@PIXIV_DOMAIN@";
            sub_filter "pximg.net" "@PXIMG_DOMAIN@";
            sub_filter "js_error.php" "block_js_error";
            sub_filter "www.google" "block_google";
            sub_filter_once off;
            sub_filter_types *;
        }
        location ~* \.(ico|jpe?g|gif|png|bmp|swf|flv)$ {
            expires 30d;
            log_not_found off;
            access_log off;
        }
        location ~* \.(js|css)$ {
            expires 7d;
            log_not_found off;
            access_log off;
        } 
    }

    #Other,return 403
    server
    {
        listen @PORT@ default_server;
        listen [::]:@PORT@ default_server;
        server_name _;
        location / {
            return 403;
        }
    }

}